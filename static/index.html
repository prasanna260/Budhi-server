<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KYC Verification</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://sdk.sandbox.co.in/kyc/digilocker/sdk.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="bg-white rounded-2xl shadow-xl p-8">
      <div class="flex justify-center mb-6">
        <div class="bg-blue-100 p-4 rounded-full">
          <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
      </div>

      <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">
        Identity Verification
      </h2>
      <p class="text-gray-600 text-center mb-8">
        Verify your identity securely using DigiLocker
      </p>

      <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>

      <button
        id="verifyButton"
        onclick="launchDigilocker()"
        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-4 px-6 rounded-lg hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Verify with DigiLocker
      </button>

      <p class="text-xs text-gray-500 text-center mt-6">
        Your data is encrypted and securely processed through DigiLocker
      </p>
    </div>
  </div>

  <script>
    var API_KEY = 'key_live_b9f5fbbff3904fbe989c6bd8ed5e0d8a';
    var BACKEND_ENDPOINT = 'http://localhost:8000/api/create-kyc-session';

    function showStatus(type, message) {
      var statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'mb-6 p-4 rounded-lg flex items-start space-x-3';
      
      var icon = '';
      var colorClasses = '';
      
      if (type === 'success') {
        colorClasses = 'bg-green-50 border border-green-200 text-green-800';
        icon = '<svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
      } else if (type === 'error') {
        colorClasses = 'bg-red-50 border border-red-200 text-red-800';
        icon = '<svg class="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
      } else if (type === 'loading') {
        colorClasses = 'bg-blue-50 border border-blue-200 text-blue-800';
        icon = '<div class="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mt-0.5 flex-shrink-0"></div>';
      }
      
      statusDiv.className += ' ' + colorClasses;
      statusDiv.innerHTML = icon + '<p class="text-sm">' + message + '</p>';
      statusDiv.classList.remove('hidden');
    }

    function hideStatus() {
      document.getElementById('statusMessage').classList.add('hidden');
    }

    function createSession() {
      return new Promise(function(resolve, reject) {
        fetch(BACKEND_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(errorData) {
              throw new Error(errorData.message || 'Failed to create session');
            });
          }
          return response.json();
        })
        .then(function(result) {
          resolve(result.session_id);
        })
        .catch(function(error) {
          reject(error);
        });
      });
    }

    function handleDigilockerEvent(event) {
      console.log('Received event:', event);

      switch (event.type) {
        case 'in.co.sandbox.kyc.digilocker_sdk.session.completed':
          showStatus('success', 'KYC verification completed successfully!');
          document.getElementById('verifyButton').disabled = true;
          document.getElementById('verifyButton').textContent = 'Verification Complete';
          break;

        case 'in.co.sandbox.kyc.digilocker_sdk.session.closed':
          showStatus('error', 'Verification was closed. Please try again.');
          document.getElementById('verifyButton').disabled = false;
          break;

        default:
          console.log('Unhandled event:', event);
      }
    }

    function launchDigilocker() {
      var button = document.getElementById('verifyButton');
      button.disabled = true;
      button.textContent = 'Processing...';
      showStatus('loading', 'Creating verification session...');

      createSession()
        .then(function(sessionId) {
          if (typeof window.DigilockerSDK !== 'undefined') {
            function EventListener(callback) {
              DigilockerSDK.EventListener.call(this);
              this.callback = callback;
            }
            
            EventListener.prototype = Object.create(DigilockerSDK.EventListener.prototype);
            EventListener.prototype.constructor = EventListener;
            
            EventListener.prototype.onEvent = function(event) {
              if (this.callback) {
                this.callback(event);
              }
            };

            var eventListener = new EventListener(handleDigilockerEvent);
            DigilockerSDK.setEventListener(eventListener);

            DigilockerSDK.setAPIKey(API_KEY);

            var options = {
              session_id: sessionId,
              brand: {
                name: 'KYC Verification',
                logo_url: 'https://images.pexels.com/photos/6963098/pexels-photo-6963098.jpeg?auto=compress&cs=tinysrgb&w=200',
              },
              theme: {
                mode: 'light',
                seed: '#2563eb',
              },
            };

            DigilockerSDK.open(options);
            showStatus('loading', 'Please complete the verification in the popup...');
          } else {
            throw new Error('DigiLocker SDK not loaded');
          }
        })
        .catch(function(error) {
          console.error('Error:', error);
          showStatus('error', error.message || 'Failed to start verification');
          button.disabled = false;
          button.textContent = 'Verify with DigiLocker';
        });
    }
  </script>
</body>
</html>